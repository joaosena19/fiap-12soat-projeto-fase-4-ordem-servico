name: Destruir OrdemServico do EKS

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Digite "destroy" para confirmar a remoção da aplicação do EKS'
        required: true

env:
  AWS_REGION: us-east-1
  SERVICE_NAME: ordemservico
  K8S_DEPLOYMENT_NAME: ordemservico-service
  K8S_SERVICE_NAME: ordemservico-service
  K8S_SECRET_NAME: ordemservico-secret
  K8S_CONFIG_NAME: ordemservico-config

jobs:
  destroy:
    name: Remover OrdemServico do EKS
    runs-on: ubuntu-latest
    
    steps:
      - name: Validar confirmação
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "Confirmação falhou. Você deve digitar 'destroy' para prosseguir."
            exit 1
          fi

      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configurar acesso ao cluster EKS
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ secrets.TF_VAR_EKS_CLUSTER_NAME }}
          kubectl cluster-info

      - name: Listar recursos antes da remoção
        run: |
          echo "=== Deployments ===" && kubectl get deployments
          echo "=== Services ===" && kubectl get services
          echo "=== ConfigMaps ===" && kubectl get configmaps
          echo "=== Secrets ===" && kubectl get secrets
          echo "=== HPAs ===" && kubectl get hpa

      - name: Remover HPA
        run: kubectl delete -f k8s/${{ env.SERVICE_NAME }}-hpa.yaml --ignore-not-found=true
        continue-on-error: true

      - name: Remover Deployment
        run: kubectl delete -f k8s/${{ env.SERVICE_NAME }}-deployment.yaml --ignore-not-found=true
        continue-on-error: true

      - name: Remover Service
        run: kubectl delete -f k8s/${{ env.SERVICE_NAME }}-service.yaml --ignore-not-found=true
        continue-on-error: true

      - name: Remover ConfigMap e Secret
        run: |
          kubectl delete configmap ${{ env.K8S_CONFIG_NAME }} --ignore-not-found=true
          kubectl delete secret ${{ env.K8S_SECRET_NAME }} --ignore-not-found=true
        continue-on-error: true

      - name: Remover metrics server
        run: kubectl delete -f k8s/metrics-server.yaml --ignore-not-found=true
        continue-on-error: true

      - name: Aguardar finalização
        run: |
          echo "Aguardando finalização da remoção dos pods..."
          sleep 30
          kubectl get pods

      - name: Verificar recursos restantes
        run: |
          echo "Verificando se todos os recursos foram removidos..."
          if kubectl get deployment ${{ env.K8S_DEPLOYMENT_NAME }} 2>/dev/null; then
            echo "⚠️ Deployment ainda existe"
          else
            echo "✅ Deployment removido com sucesso"
          fi
          
          if kubectl get service ${{ env.K8S_SERVICE_NAME }} 2>/dev/null; then
            echo "⚠️ Service ainda existe"
          else
            echo "✅ Service removido com sucesso"
          fi

      - name: Destruição completa
        run: echo "✅ OrdemServico removido do EKS com sucesso"
